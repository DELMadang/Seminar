## ë¸íŒŒì´ Horseë¥¼ í™œìš©í•œ REST ì„œë²„ êµ¬í˜„ ì„¸ë¯¸ë‚˜

### **0. ì„¸ë¯¸ë‚˜ ê°œìš”**

#### 0.1 ê°œìš”

**ì´ ì†Œìš”ì‹œê°„**: 2ì‹œê°„ (120ë¶„)  
**ëŒ€ìƒ**: ë¸íŒŒì´ ê°œë°œ ê²½í—˜ì´ ìˆëŠ” ê°œë°œì  
**ëª©í‘œ**: Horse í”„ë ˆì„ì›Œí¬ë¥¼ ì‚¬ìš©í•˜ì—¬ ì‹¤ë¬´ì—ì„œ í™œìš© ê°€ëŠ¥í•œ REST API ì„œë²„ êµ¬ì¶•

#### 0.2 í•„ìš”í•œ ì‚¬ì „ ì¤€ë¹„ì‚¬í•­

- ë°ì´í„°ë² ì´ìŠ¤: [MariaDB](https://mariadb.org/download/)
- ì¿¼ë¦¬ ë¸Œë¼ìš°ì €: [DBEaver](https://dbeaver.io/download/)

#### 0.3 ê°œë°œ ë„êµ¬

- Delphi XE8 ì´ìƒ

### **1. REST API ê°œìš”**

#### 1.1 REST APIë€?

**REST API**ëŠ” ì›¹ì—ì„œ ë°ì´í„°ë¥¼ ì£¼ê³ ë°›ê¸° ìœ„í•œ í‘œì¤€ ê·œì¹™ì…ë‹ˆë‹¤.
ë§ˆì¹˜ ë ˆìŠ¤í† ë‘ì˜ ë©”ë‰´íŒì²˜ëŸ¼, í´ë¼ì´ì–¸íŠ¸ê°€ ì„œë²„ì—ê²Œ "ì´ëŸ° ë°ì´í„°ë¥¼ ë‹¬ë¼" ë˜ëŠ” "ì´ëŸ° ì‘ì—…ì„ í•´ë‹¬ë¼"ê³  ìš”ì²­í•˜ëŠ” ë°©ì‹ì„ ì •ì˜í•˜ë©°, í†µì‹  í”„ë¡œí† ì½œì€ HTTP/HTTPSë¥¼ ë°ì´í„°ëŠ” JSONì„ ì‚¬ìš©í•©ë‹ˆë‹¤.

> **REST** = **RE**presentational **S**tate **T**ransfer(í‘œí˜„ ìƒíƒœ ì „ì´)

#### 1.2 REST APIì˜ í•µì‹¬ êµ¬ì¡°

HTTP ë©”ì†Œë“œ + URL = ì‘ì—… ì •ì˜

<table>
  <th width=400px>ìš”ì²­</th>
  <th width=200px>ì˜ë¯¸</th>
  <tr>
    <td><b>GET</b> /users</td>
    <td>ì‚¬ìš©ì ëª©ë¡ ì¡°íšŒ</td>
  </tr>
  <tr>
    <td>GET /users/123</td>
    <td>123ë²ˆ ì‚¬ìš©ì ì¡°íšŒ</td>
  </tr>
  <tr>
    <td>POST /users</td>
    <td>ìƒˆ ì‚¬ìš©ì ìƒì„±</td>
  </tr>
  <tr>
    <td>PUTT /user/123</td>
    <td>123ë²ˆ ì‚¬ìš©ì ìˆ˜ì •</td>
  </tr>
  <tr>
    <td>DELETE /user/123</td>
    <td>123ë²ˆ ì‚¬ìš©ì ì‚­ì œ</td>
  </tr>
</table>

#### 1.3 REST APIì˜ 5ê°€ì§€ í•µì‹¬ ì›ì¹™

##### 1.3.1 ë¦¬ì†ŒìŠ¤ ì¤‘ì‹¬ ì„¤ê³„

HTTP ë©”ì†Œë“œëŠ” ë™ì‚¬ë¡œ, URLì€ ëª…ì‚¬ë¡œ í‘œí˜„í•œë‹¤

<table>
  <th width=400px>ìš”ì²­</th>
  <th width=200px>ë¹„ê³ </th>
  <tr>
    <td>GET /books/123</td>
    <td>ì¢‹ì€ ì˜ˆ</td>
  </tr>
  <tr>
    <td>GET /getBook/123</td>
    <td>ë‚˜ìœ ì˜ˆ</td>
  </tr>
</table>

##### 1.3.2 ë¬´ìƒíƒœ(Stateless)

ì„œë²„ëŠ” ì´ì „ ìš”ì²­ì„ ê¸°ì–µí•˜ì§€ ì•ŠìŒ. ë§¤ ìš”ì²­ë§ˆë‹¤ í•„ìš”í•œ ëª¨ë“  ì •ë³´ í¬í•¨í•´ì•¼ í•œë‹¤

> ë§¤ë²ˆ ì¸ì¦ í† í° í¬í•¨
> GET /api/users
> Authorization: Bearer abc123token

##### 1.3.3 í‘œì¤€ HTTP ë©”ì†Œë“œ ì‚¬ìš©

<table>
  <th width=400px>ë©”ì†Œë“œ</th>
  <th width=200px>ì˜ë¯¸</th>
  <tr>
    <td>GET</td>
    <td>ì¡°íšŒ</td>
  </tr>
  <tr>
    <td>POST</td>
    <td>ìƒì„±</td>
  </tr>
  <tr>
    <td>PUT</td>
    <td>ìˆ˜ì •</td>
  </tr>
  <tr>
    <td>DELETE</td>
    <td>ì‚­ì œ</td>
  </tr>
</table>

##### 1.3.4 ê³„ì¸µí™”ëœ êµ¬ì¡°

í´ë¼ì´ì–¸íŠ¸ëŠ” ì„œë²„ì˜ ë‚´ë¶€ êµ¬ì¡°ë¥¼ ëª°ë¼ë„ ë¨

```mermaid
flowchart TD
    %% í´ë¼ì´ì–¸íŠ¸ ê³„ì¸µ
    A1[ğŸ–¥ï¸ ì›¹ ë¸Œë¼ìš°ì €] --> C[âš–ï¸ ë¡œë“œë°¸ëŸ°ì„œ ]
    A2[ğŸ“± ëª¨ë°”ì¼ ì•±] --> C
    A3[ğŸ’» ë°ìŠ¤í¬í†± ì•±] --> C
    
    %% ë¡œë“œë°¸ëŸ°ì„œì—ì„œ ì„œë²„ë“¤ë¡œ ë¶„ì‚°
    C --> |íŠ¸ë˜í”½ ë¶„ì‚°| D1[ğŸ–¥ï¸ ì„œë²„ 1]
    C --> |íŠ¸ë˜í”½ ë¶„ì‚°| D2[ğŸ–¥ï¸ ì„œë²„ 2]
    C --> |íŠ¸ë˜í”½ ë¶„ì‚°| D3[ğŸ–¥ï¸ ì„œë²„ 3]
    
    %% ì„œë²„ë“¤ì´ ë°ì´í„°ë² ì´ìŠ¤ì— ì ‘ê·¼
    D1 --> E[ğŸ—„ï¸ ë°ì´í„°ë² ì´ìŠ¤<br/>RDBMS or NoSQL ]
    D2 --> E
    D3 --> E
    
    %% ìŠ¤íƒ€ì¼ ì •ì˜
    classDef client fill:#e1f5fe,stroke:#0277bd,stroke-width:2px
    classDef gateway fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px
    classDef loadbalancer fill:#fff3e0,stroke:#f57c00,stroke-width:2px
    classDef server fill:#e8f5e8,stroke:#388e3c,stroke-width:2px
    classDef database fill:#ffebee,stroke:#d32f2f,stroke-width:2px
    
    class A1,A2,A3 client
    class B gateway
    class C loadbalancer
    class D1,D2,D3 server
    class E database
```

##### 1.3.5 ìºì‹œ ê°€ëŠ¥

GET ìš”ì²­ ê²°ê³¼ëŠ” ìºì‹œí•˜ì—¬ ì„±ëŠ¥ í–¥ìƒ

> Cache-Control: max-age=3600
> ETag: "abc123"

### **2. HORSE í”„ë ˆì„ì›Œí¬ ì†Œê°œ**

#### 2.1 Horse í”„ë ˆì„ì›Œí¬ íŠ¹ì§•

##### 2.1.1 ê²½ëŸ‰í™”ì™€ ê³ ì„±ëŠ¥

- ë„¤ì´í‹°ë¸Œ ì»´íŒŒì¼
- ë©”ëª¨ë¦¬ íš¨ìœ¨ (ë§¤ìš° ì ì€ ë©”ëª¨ë¦¬ë§Œ ì‚¬ìš©í•œë‹¤)
- ë¹ ë¥¸ ì‹¤í–‰ ì†ë„
- ê²½ëŸ‰í™”ëœ ì›¹ í”„ë ˆì„ì›Œí¬
- ê°„ë‹¨í•œ ë¼ìš°íŒ… ì‹œìŠ¤í…œ

##### 2.1.2 ê°„ë‹¨í•˜ê³  ì§ê´€ì ì¸ ë¬¸ë²•

- í•™ìŠµ ê³¡ì„ ì´ ë‚®ìŒ
- Nodeì˜ Expressì™€ ìœ ì‚¬
- ê°€ë…ì„±ì´ ì¢‹ìŒ.

##### 2.1.3 ë‹¤ì–‘í•˜ê³  ê°•ë ¥í•œ ë¯¸ë“¤ì›¨ì–´ ì‹œìŠ¤í…œ

- ëª¨ë“ˆí™”: ê¸°ëŠ¥ë³„ë¡œ ë¯¸ë“¤ì›¨ì–´ ë¶„ë¦¬
- ì¬ì‚¬ìš©ì„±: ë‹¤ë¥¸ í”„ë¡œì íŠ¸ì—ì„œë„ ë™ì¼í•œ ë¯¸ë“¤ì›¨ì–´ ì‚¬ìš©
- í™•ì¥ì„±: í•„ìš”í•œ ë¯¸ë“¤ì›¨ì–´ë§Œ ì¶”ê°€/ì œê±° ê°€ëŠ¥

##### 2.1.4 ë‹¤ì–‘í•œ OS ì§€ì›

- Windows
- Linux
- macOS

##### 2.1.5 ë¸íŒŒì´ ìƒíƒœê³„ì™€ì˜ í†µí•©

- ê¸°ì¡´ ë¸íŒŒì´ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤
- FireDAC, UniDAC ë“± ë‹¤ì–‘í•œ ë°ì´í„°ë² ì´ìŠ¤ ë“œë¼ì´ë²„ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤

##### 2.1.6 ê°„í¸í•œ ë°°í¬ì™€ ìš´ì˜

- ë‹¨ì¼ ì‹¤í–‰íŒŒì¼ë¡œ ë°°í¬ì™€ ìš´ì˜ì´ í¸ë¦¬ (ëŸ°íƒ€ì„ ë¶ˆí•„ìš”)
- ë„ì»¤ë¡œ ë°°í¬ ê°€ëŠ¥
- í´ë¼ìš°ë“œì— ë°°í¬ ê°€ëŠ¥

##### 2.1.7 ë‹¤ë¥¸ í”„ë ˆì„ì›Œí¬ë“¤

- **DataSnap** ë˜ëŠ” **WebBroker**
  ë¸íŒŒì´ì—ì„œ ê¸°ë³¸ìœ¼ë¡œ ì œê³µí•œë‹¤. 12.2ì—ì„œëŠ” ì›¹ìŠ¤í…ì‹¤ì„ ì‚¬ìš©í•´ì„œ í…œí”Œë¦¿ì„ ì‰½ê²Œ ë§Œë“¤ ìˆ˜ ìˆë‹¤.
- **MARS**
  <https://github.com/andrea-magni/MARS>
- **WiRL**
  <https://github.com/delphi-blocks/WiRL>
  MARSì™€ WiRLì€ ê°™ì€ ë¿Œë¦¬ì—ì„œ ë‚˜ì˜¨ ê²ƒìœ¼ë¡œ ë³´ì´ëŠ”ë° MARSê°€ êµ¬í˜„ëœ ê²ƒì´ ì¡°ê¸ˆ ë” ë§ì§€ë§Œ, WiRLì´ ì½”ë“œëŠ” í›¨ì”¬ ì •ê°ˆí•˜ë‹¤.
- **DelphiMVCFramework**
  <https://github.com/danieleteti/delphimvcframework>
  ê°€ì¥ ì—…ë°ì´íŠ¸ê°€ í™œë°œí•˜ë‹¤. ì†ŒìŠ¤ì½”ë“œ ì •ëˆì´ ì˜ ì•ˆëœì ì€ ì•„ì‰½ë‹¤.
- **TMS WebCore**
  <https://www.tmssoftware.com/site/tmswebcore.asp>
  ë¸íŒŒì´ Formì„ ì›¹ìœ¼ë¡œ ì „í™˜í•´ì£¼ëŠ” ë“±ì˜ ê¸°ëŠ¥ì´ ìˆë‹¤. ìœ ë£Œ
- **Intraweb**
  <https://www.atozed.com/intraweb/>
  ê°€ì¥ ì˜¤ë˜ëœ ì†”ë£¨ì…˜. ìœ ë£Œ.
- **UniGUI**
  <https://www.unigui.com/>
  ìœ ë£Œ
- **D2Bridge**
  <https://www.d2bridge.com.br/#>
  ë¸íŒŒì´ Formì„ ì›¹ìœ¼ë¡œ ì „í™˜í•´ì£¼ëŠ” ë“±ì˜ ê¸°ëŠ¥ì´ ìˆë‹¤.
  ì˜¤í”ˆì†ŒìŠ¤
â€‹

#### 2.2 ì†ŒìŠ¤ì½”ë“œ ë‹¤ìš´ë¡œë“œ

ë¸ë§ˆë‹¹ ê³µì‹ ë¦¬í¬ì§€í† ë¦¬ì—ì„œ í´ë¡ í•œë‹¤
[ë¸ë§ˆë‹¹ ì„¸ë¯¸ë‚˜ ë¦¬í¬ì§€í† ë¦¬](https://github.com/DELMadang/Seminar)

í´ë¡  í›„ í´ë”ì˜ êµ¬ì„±ì€ ë‹¤ìŒê³¼ ê°™ë‹¤.

```console
01.RESTServer/
  â”œâ”€â”€ bin                     // ì‹¤í–‰ íŒŒì¼ì´ ìƒì„±ë˜ëŠ” ê³³
  â”œâ”€â”€ database
  â”‚   â””â”€â”€ schema.sql          // MariaDBìš© ìŠ¤í‚¤ë§ˆ
  â”œâ”€â”€ docs
  â”‚   â””â”€â”€ Seminar_20250723.md // í˜„ì¬ ë³´ê³  ìˆëŠ” ë¬¸ì„œ
  â”œâ”€â”€ lib
  â”‚   â”œâ”€â”€ Horse               // Horse ì—”ì§„ ìœ ë‹›ë“¤
  â”‚   â””â”€â”€ MiddleWare          // ë¯¸ë“¤ì›¨ì–´ ìœ ë‹›ë“¤
  â”‚   â””â”€â”€ Swagger             // ìŠ¤ì›¨ê±° ìœ ë‹›ë“¤
  â””â”€â”€ src
      â”œâ”€â”€ 00.Raw              // Indyë¥¼ ì‚¬ìš©í•œ ì„œë²„
      â”œâ”€â”€ 01.Basic            // ê¸°ë³¸ ì„œë²„
      â”œâ”€â”€ 02.MiddleWare       // ë¯¸ë“¤ì›¨ì–´ ì ìš©í•œ ì„œë²„
      â”œâ”€â”€ 03.Database         // ë°ì´í„°ë² ì´ìŠ¤ ì—°ë™ ì„œë²„
      â”œâ”€â”€ 04.Client           // í´ë¼ì´ì–¸íŠ¸
      â””â”€â”€ 99.NodeJS           // NodeJS ì˜ˆì œ
```

#### 2.3 Indyë¥¼ ì‚¬ìš©í•˜ì—¬ êµ¬í˜„í•˜ê¸°

í”„ë ˆì„ì›Œí¬ì˜ ë„ì›€ì—†ì´ ì„œë²„ë¥¼ êµ¬í˜„í•´ ë³´ë©´ì„œ, í”„ë ˆì„ì›Œí¬ì˜ í•„ìš”ì„±ì— ëŒ€í•´ ì•Œì•„ë³¸ë‹¤

```pascal
constructor TfrmMain.Create(AOwner: TComponent);
begin
  inherited;

  FServer := TIdHttpServer.Create(Self);
end;

destructor TfrmMain.Destroy;
begin
  FServer.Active := False;
  FServer.Free;

  inherited;
end;

procedure TfrmMain.btnExecuteClick(Sender: TObject);
begin
  var LURL := Format('http://localhost:%d/hello', [FServer.Bindings[0].Port]);
  ShellExecute(0, 'open', PChar(LURL), nil, nil, SW_SHOW);
end;

procedure TfrmMain.btnStartClick(Sender: TObject);
begin
  Start;
end;

procedure TfrmMain.btnStopClick(Sender: TObject);
begin
  Stop;
end;

procedure TfrmMain.Start(const APort: Integer);
begin
  FServer.Bindings.Clear;

  with FServer.Bindings.Add do
  begin
    IP := '0.0.0.0';
    Port := APort;
  end;

  FServer.OnCommandGet := TriggerCommandGet;
  FServer.Active := True;
end;

procedure TfrmMain.Stop;
begin
  FServer.Active := False;
end;

procedure TfrmMain.TriggerCommandGet(AContext: TIdContext;
  ARequestInfo: TIdHTTPRequestInfo; AResponseInfo: TIdHTTPResponseInfo);
begin
  if SameText(ARequestInfo.URI, '/hello') then
  begin
    AResponseInfo.ContentType := 'application/json';
    AResponseInfo.ContentText := '{"response": "Hello, world"}';
  end;
end;
```

#### 2.4 ê¸°ë³¸ ì„œë²„ êµ¬í˜„

ê°€ì¥ ê¸°ë³¸ì´ ë˜ëŠ” ì„œë²„ë¥¼ êµ¬í˜„í•´ ë³´ë©´ì„œ ë¼ìš°í„°ì˜ ì‚¬ìš©ë²•ì— ëŒ€í•´ ìµíŒë‹¤.

```pascal
program BasicServer;

uses 
  System.SysUtils,
  Horse;

begin
  // ë¼ìš°í„°ì— ë“±ë¡í•œë‹¤
  THorse.Get('/hello', 
    procedure(Req: THorseRequest; Res: THorseResponse; Next: TProc)
    begin
      Res.Send('Hello World!');
    end);
  
  // 9000ë²ˆ í¬íŠ¸ë¥¼ ë¦¬ìŠ¤ë‹í•œë‹¤
  THorse.Listen(9000);
end.
```

### **3. ë¯¸ë“¤ì›¨ì–´**

#### 3.1 ë¯¸ë“¤ì›¨ì–´ë€?

- ìš”ì²­-ì‘ë‹µ ì‚¬ì´í´ì—ì„œì˜ ì¤‘ê°„ ì²˜ë¦¬
- ê³µì‹ ë¯¸ë“¤ì›¨ì–´
  - **horse/json** SON ì²˜ë¦¬ë¥¼ ìœ„í•œ ë¯¸ë“¤ì›¨ì–´
  - **horse/basic-auth** ê¸°ë³¸ ì¸ì¦ì§€ì›
  - **horse/cors** Cross-Origun Resource Sharing ì§€ì›
  - **horse/stream** ë°”ì´ë„ˆë¦¬ ìŠ¤íŠ¸ë¦¼ ì „ì†¡ ì§€ì›
  - **horse/jwt** JWT ì¸ì¦ ì§€ì›
  - **horse/exception** ìµì…‰ì…˜ ì²˜ë¦¬ ì§€ì›
  - **horse/logger** ë¡œê¹… ì§€ì›
  - **horse/compression** ì‘ë‹µ ì••ì¶• ì§€ì›
- ë¹„ê³µì‹ ë¯¸ë“¤ì›¨ì–´
  - ì‚¬ìš©ìë“¤ì´ ê°œë°œí•œ ë‹¤ì–‘í•œ ë¯¸ë“¤ì›¨ì–´ê°€ ì¡´ì¬í•˜ë©°
  - í•„ìš”ì— ë”°ë¼ ë¯¸ë“¤ì›¨ì–´ë¥¼ ì§ì ‘ ë§Œë“¤ì–´ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤

#### 3.2 ë¯¸ë“¤ì›¨ì–´ ì‚¬ìš©í•´ë³´ê¸°

##### 3.2.1 JSON ë¯¸ë“¤ì›¨ì–´

JSON ë¯¸ë“¤ì›¨ì–´ëŠ” ì›¹ ì„œë²„ë‚˜ API ì„œë²„ì—ì„œ JSON ë°ì´í„°ë¥¼ ìë™ìœ¼ë¡œ íŒŒì‹±í•˜ê³  ì²˜ë¦¬í•˜ëŠ” ì¤‘ê°„ ê³„ì¸µ(middleware) ì†Œí”„íŠ¸ì›¨ì–´ì…ë‹ˆë‹¤.

**JSON ë¯¸ë“¤ì›¨ì–´ì˜ ì—­í• **

- ìš”ì²­ ì²˜ë¦¬
  HTTP ìš”ì²­ ë³¸ë¬¸ì˜ JSONì„ ìë™ íŒŒì‹±
  Content-Type ê²€ì¦ (application/json)
  íŒŒì‹± ì—ëŸ¬ ì²˜ë¦¬
- ì‘ë‹µ ì²˜ë¦¬
  ê°ì²´ë¥¼ JSONìœ¼ë¡œ ìë™ ì§ë ¬í™”
  ì ì ˆí•œ Content-Type í—¤ë” ì„¤ì •
  JSON í¬ë§·íŒ… (ë“¤ì—¬ì“°ê¸°, ì••ì¶• ë“±)

```pascal
program Middlware01;

{$APPTYPE CONSOLE}

uses
  System.SysUtils,
  System.JSON,
  Horse,
  Horse.Jhonson;

begin
  // ë¯¸ë“¤ì›¨ì–´ ë“±ë¡
  THorse.Use(Jhonson());

  // ë¼ìš°í„°ì— ë“±ë¡í•œë‹¤
  THorse.Get('/hello',
    procedure(Req: THorseRequest; Res: THorseResponse; Next: TProc)
    var
      LResult: TJSONObject;
    begin
      LResult := TJSONObject.Create;
      LResult.AddPair('response', 'Hello, World');
      Res.Send<TJSONObject>(LResult);
    end);

  // 9000ë²ˆ í¬íŠ¸ë¥¼ ë¦¬ìŠ¤ë‹í•œë‹¤
  THorse.Listen(9000);
end.
```

##### 3.2.2 basic-auth

Basic Authenticationì€ HTTP í”„ë¡œí† ì½œì—ì„œ ê°€ì¥ ê¸°ë³¸ì ì¸ ì¸ì¦ ë°©ì‹ì…ë‹ˆë‹¤.
Basic Authentication ë™ì‘ ì›ë¦¬

1. ì¸ì½”ë”© ë°©ì‹

- ì‚¬ìš©ìëª…ê³¼ íŒ¨ìŠ¤ì›Œë“œë¥¼ ì½œë¡ (:)ìœ¼ë¡œ ì—°ê²°
- Base64ë¡œ ì¸ì½”ë”©
- HTTP í—¤ë”ì— í¬í•¨í•˜ì—¬ ì „ì†¡

```text
username:password â†’ Base64 ì¸ì½”ë”© â†’ dXNlcm5hbWU6cGFzc3dvcmQ=
```

2. HTTP í—¤ë” í˜•ì‹

```text
Authorization: Basic dXNlcm5hbWU6cGFzc3dvcmQ=
```

3. ë³´ì•ˆ ê³ ë ¤ì‚¬í•­

**ì¥ì :**

- êµ¬í˜„ì´ ê°„ë‹¨í•¨
- ëª¨ë“  HTTP í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì§€ì›
- ì„œë²„ ì„¸ì…˜ ìƒíƒœ ë¶ˆí•„ìš”

**ë‹¨ì :**

- Base64ëŠ” ì•”í˜¸í™”ê°€ ì•„ë‹Œ ì¸ì½”ë”© (ì‰½ê²Œ ë””ì½”ë”© ê°€ëŠ¥)
- ë§¤ ìš”ì²­ë§ˆë‹¤ ì¸ì¦ ì •ë³´ ì „ì†¡
- ë¸Œë¼ìš°ì €ì— íŒ¨ìŠ¤ì›Œë“œ ì €ì¥ ìœ„í—˜

```pascal
program Middlware02;

{$APPTYPE CONSOLE}

uses
  System.SysUtils,
  System.JSON,

  Horse,
  Horse.Jhonson,
  Horse.BasicAuthentication;

begin
  // ë¯¸ë“¤ì›¨ì–´ ë“±ë¡
  THorse.Use(Jhonson());

  // BasicAuthë¥¼ ì²˜ë¦¬í•˜ê¸° ìœ„í•œ ë¯¸ë“¤ì›¨ì–´
  THorse.Use(HorseBasicAuthentication(
    function(const AUsername, APassword: string): Boolean
    begin
      Result := AUsername.Equals('user') and APassword.Equals('password');
    end));

  // ë¼ìš°í„°ì— ë“±ë¡í•œë‹¤
  THorse.Get('/hello',
    procedure(Req: THorseRequest; Res: THorseResponse; Next: TProc)
    var
      LResult: TJSONObject;
    begin
      LResult := TJSONObject.Create;
      LResult.AddPair('response', 'Hello, World');
      Res.Send<TJSONObject>(LResult);
    end);

  // 9000ë²ˆ í¬íŠ¸ë¥¼ ë¦¬ìŠ¤ë‹í•œë‹¤
  THorse.Listen(9000);
end.
```

ë¸Œë¼ìš°ì €ì—ì„œ í…ŒìŠ¤íŠ¸ í•˜ê¸°

```text
http://user:password@localhost:9000/hello
```

##### 3.2.3 cors

CORS(Cross-Origin Resource Sharing)ëŠ” ì›¹ ë¸Œë¼ìš°ì €ì˜ Same-Origin Policy(ë™ì¼ ì¶œì²˜ ì •ì±…) ì œí•œì„ ìš°íšŒí•˜ê¸° ìœ„í•´ ì‚¬ìš©ë©ë‹ˆë‹¤.

**Same-Origin Policyë€?**
ì›¹ ë¸Œë¼ìš°ì €ëŠ” ë³´ì•ˆìƒ ì´ìœ ë¡œ ë‹¤ìŒ ì¡°ê±´ì´ ëª¨ë‘ ê°™ì€ ê²½ìš°ì—ë§Œ ë¦¬ì†ŒìŠ¤ ì ‘ê·¼ì„ í—ˆìš©í•©ë‹ˆë‹¤:

- í”„ë¡œí† ì½œ (http/https)
- ë„ë©”ì¸ (example.com)
- í¬íŠ¸ (80, 443, 8080 ë“±)

**CORS ë™ì‘ ê³¼ì •**

- Preflight Request: ë¸Œë¼ìš°ì €ê°€ OPTIONS ìš”ì²­ìœ¼ë¡œ ì„œë²„ì— í—ˆê°€ ìš”ì²­
- ì„œë²„ ì‘ë‹µ: í—ˆìš©ëœ origin, ë©”ì„œë“œ, í—¤ë” ì •ë³´ ë°˜í™˜
- ì‹¤ì œ ìš”ì²­: í—ˆê°€ë°›ì€ ê²½ìš°ì—ë§Œ ì‹¤ì œ API í˜¸ì¶œ ì‹¤í–‰

**ì£¼ì˜ì‚¬í•­**

- ë³´ì•ˆ: * (ëª¨ë“  ë„ë©”ì¸ í—ˆìš©)ì€ ìš´ì˜ í™˜ê²½ì—ì„œ ìœ„í—˜
- ì„±ëŠ¥: Preflight ìš”ì²­ìœ¼ë¡œ ì¸í•œ ì¶”ê°€ ë„¤íŠ¸ì›Œí¬ ë¹„ìš©
- ì„¤ì •: í•„ìš”í•œ originë§Œ ì •í™•íˆ í—ˆìš©í•´ì•¼ í•¨

CORSëŠ” ì›¹ ë¸Œë¼ìš°ì €ì—ì„œë§Œ ì ìš©ë˜ëŠ” ì •ì±…ì´ë¯€ë¡œ, ë°ìŠ¤í¬í†± ì• í”Œë¦¬ì¼€ì´ì…˜ì´ë‚˜ ì„œë²„ ê°„ í†µì‹ ì—ëŠ” ì˜í–¥ì„ ì£¼ì§€ ì•ŠìŠµë‹ˆë‹¤.

```pascal
program Middlware03;

{$APPTYPE CONSOLE}

uses
  System.SysUtils,
  System.JSON,

  Horse,
  Horse.Jhonson,
  Horse.BasicAuthentication,
  Horse.CORS;

begin
  // ë¯¸ë“¤ì›¨ì–´ ë“±ë¡
  HorseCORS
    .AllowedOrigin('*')
    .AllowedCredentials(true)
    .AllowedHeaders('*')
    .AllowedMethods('*')
    .ExposedHeaders('*');

  // It's necessary to add the middleware in the Horse:
  THorse.Use(CORS);

  THorse.Use(Jhonson());

  // BasicAuthë¥¼ ì²˜ë¦¬í•˜ê¸° ìœ„í•œ ë¯¸ë“¤ì›¨ì–´
  THorse.Use(HorseBasicAuthentication(
    function(const AUsername, APassword: string): Boolean
    begin
      Result := AUsername.Equals('user') and APassword.Equals('password');
    end));

  // ë¼ìš°í„°ì— ë“±ë¡í•œë‹¤
  THorse.Get('/hello',
    procedure(Req: THorseRequest; Res: THorseResponse; Next: TProc)
    var
      LResult: TJSONObject;
    begin
      LResult := TJSONObject.Create;
      LResult.AddPair('response', 'Hello, World');
      Res.Send<TJSONObject>(LResult);
    end);

  // 9000ë²ˆ í¬íŠ¸ë¥¼ ë¦¬ìŠ¤ë‹í•œë‹¤
  THorse.Listen(9000);
end.
```

##### 3.2.4 stream

Streamì„ ë‹¤ë£¨ê¸° ìœ„í•œ ê³µì‹ ë¯¸ë“¤ì›¨ì–´ì…ë‹ˆë‹¤. ì´ ë¯¸ë“¤ì›¨ì–´ë¥¼ ì‚¬ìš©í•˜ë©´ ì›¹ APIì—ì„œ íŒŒì¼ì´ë‚˜ ë°”ì´ë„ˆë¦¬ ë°ì´í„°ë¥¼ ìŠ¤íŠ¸ë¦¼ìœ¼ë¡œ ì „ì†¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì£¼ìš” íŠ¹ì§•

- íŒŒì¼ ì „ì†¡: PDF, ì´ë¯¸ì§€, ë™ì˜ìƒ ë“± ë‹¤ì–‘í•œ íŒŒì¼ í˜•ì‹ì„ ìŠ¤íŠ¸ë¦¼ìœ¼ë¡œ ì „ì†¡
- ë©”ëª¨ë¦¬ íš¨ìœ¨ì„±: ëŒ€ìš©ëŸ‰ íŒŒì¼ë„ ë©”ëª¨ë¦¬ì— ëª¨ë‘ ë¡œë“œí•˜ì§€ ì•Šê³  ìŠ¤íŠ¸ë¦¼ìœ¼ë¡œ ì²˜ë¦¬
- Content-Type ì„¤ì •: íŒŒì¼ í˜•ì‹ì— ë§ëŠ” MIME íƒ€ì… ìë™ ì„¤ì •
- MIT ë¼ì´ì„ ìŠ¤: ë¬´ë£Œ ì˜¤í”ˆì†ŒìŠ¤

```pascal
program Middlware04;

{$APPTYPE CONSOLE}

uses
  System.SysUtils,
  System.Classes,
  System.IOUtils,

  Horse,
  Horse.OctetStream;

begin
  THorse.Use(OctetStream);

  THorse.Get('/stream',
    procedure(Req: THorseRequest; Res: THorseResponse; Next: TProc)
    var
      LStream: TFileStream;
    begin
      LStream := TFileStream.Create(ExtractFilePath(ParamStr(0)) + 'horse.pdf', fmOpenRead);
      Res.Send<TStream>(LStream).ContentType('application/pdf');
    end);

  THorse.Get('/download/:filename',
    procedure(Req: THorseRequest; Res: THorseResponse; Next: TProc)
    var
      LPath: string;
      LStream: TFileStream;
    begin
      LPath := TPath.Combine(ExtractFilePath(ParamStr(0)), Req.Params['filename']);
      if TFile.Exists(LPath) then
      begin
        LStream := TFileStream.Create(LPath, fmOpenRead);
        Res.Send<TStream>(LStream).ContentType('application/pdf');
      end
      else
      begin
        Res.Status(THTTPStatus.NotFound);
      end;
    end);

  // 9000ë²ˆ í¬íŠ¸ë¥¼ ë¦¬ìŠ¤ë‹í•œë‹¤
  THorse.Listen(9000);
end.
```

##### 3.2.5 jwt

JWTë€?
JWTëŠ” ë‹¹ì‚¬ì ê°„ì— ì •ë³´ë¥¼ JSON ê°ì²´ë¡œ ì•ˆì „í•˜ê²Œ ì „ì†¡í•˜ê¸° ìœ„í•œ ê°œë°©í˜• í‘œì¤€(RFC 7519)ì…ë‹ˆë‹¤. ì£¼ë¡œ **ì¸ì¦(Authentication)**ê³¼ ì •ë³´ êµí™˜ì— ì‚¬ìš©ë©ë‹ˆë‹¤.

JWT êµ¬ì¡°
JWTëŠ” ì (.)ìœ¼ë¡œ êµ¬ë¶„ëœ ì„¸ ë¶€ë¶„ìœ¼ë¡œ êµ¬ì„±ë©ë‹ˆë‹¤:

```text
Header.Payload.Signature
```

1.Header (í—¤ë”)

- í† í° íƒ€ì…(JWT)ê³¼ í•´ì‹± ì•Œê³ ë¦¬ì¦˜ ì •ë³´
- Base64Urlë¡œ ì¸ì½”ë”©

```json
{
  "alg": "HS256",
  "typ": "JWT"
}
```

2.Payload (í˜ì´ë¡œë“œ)

- ì‹¤ì œ ì „ì†¡í•  ë°ì´í„°(í´ë ˆì„)
- ì‚¬ìš©ì ì •ë³´, ê¶Œí•œ, ë§Œë£Œì‹œê°„ ë“±

```json
{
  "sub": "1234567890",
  "name": "John Doe",
  "iat": 1516239022,
  "exp": 1516242622
}
```

3.Signature (ì„œëª…)

- í† í°ì˜ ë¬´ê²°ì„± ê²€ì¦
- Header + Payload + Secret Keyë¡œ ìƒì„±

**ë™ì‘ ë°©ì‹**

- ë¡œê·¸ì¸: ì‚¬ìš©ìê°€ ì¸ì¦ ì •ë³´ ì œê³µ
- í† í° ë°œê¸‰: ì„œë²„ê°€ JWT ìƒì„± í›„ í´ë¼ì´ì–¸íŠ¸ì— ì „ì†¡
- í† í° ì‚¬ìš©: í´ë¼ì´ì–¸íŠ¸ê°€ ìš”ì²­ ì‹œ JWTë¥¼ Headerì— í¬í•¨
- ê²€ì¦: ì„œë²„ê°€ JWT ì„œëª…ì„ ê²€ì¦í•˜ì—¬ ì‚¬ìš©ì ì¸ì¦

**ì¥ì **

- ìƒíƒœ ì—†ìŒ(Stateless): ì„œë²„ì— ì„¸ì…˜ ì •ë³´ ì €ì¥ ë¶ˆí•„ìš”
- í™•ì¥ì„±: ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ í™˜ê²½ì— ì í•©
- í¬ë¡œìŠ¤ ë„ë©”ì¸: CORS ë¬¸ì œ í•´ê²°
- ëª¨ë°”ì¼ ì¹œí™”ì : ì¿ í‚¤ ëŒ€ì‹  ì‚¬ìš© ê°€ëŠ¥

**ë‹¨ì **

- í† í° í¬ê¸°: ì¿ í‚¤ë³´ë‹¤ í¬ê¸°ê°€ í¼
- ë³´ì•ˆ: í† í° íƒˆì·¨ ì‹œ ë§Œë£Œ ì „ê¹Œì§€ ì‚¬ìš© ê°€ëŠ¥
- ì„œë²„ ì¸¡ ë¬´íš¨í™” ì–´ë ¤ì›€: ë¸”ë™ë¦¬ìŠ¤íŠ¸ ê´€ë¦¬ í•„ìš”

**ì£¼ìš” ì‚¬ìš© ì‚¬ë¡€**

- ì¸ì¦/ì¸ê°€: ë¡œê·¸ì¸ í›„ API ì ‘ê·¼ ì œì–´
- ì •ë³´ êµí™˜: ì„œë¹„ìŠ¤ ê°„ ì•ˆì „í•œ ë°ì´í„° ì „ì†¡
- SSO(Single Sign-On): ì—¬ëŸ¬ ì„œë¹„ìŠ¤ ê°„ ì¸ì¦ ê³µìœ 

JWTëŠ” í˜„ëŒ€ ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ í‘œì¤€ì ìœ¼ë¡œ ì‚¬ìš©ë˜ëŠ” ì¸ì¦ ë°©ì‹ìœ¼ë¡œ, REST APIë‚˜ ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ì•„í‚¤í…ì²˜ì—ì„œ íŠ¹íˆ ìœ ìš©í•©ë‹ˆë‹¤.

```pascal
uses 
  Horse, 
  Horse.JWT;

begin
  THorse.Use(HorseJWT('MY-PASSWORD')); 

  THorse.Post('ping',
    procedure(Req: THorseRequest; Res: THorseResponse; Next: TProc)
    begin
      Res.Send('pong');
    end);

  THorse.Listen(9000);
end.
```

##### 3.2.6 exception

Handle-exceptionì€ Horse í”„ë ˆì„ì›Œí¬ì—ì„œ ì˜ˆì™¸ë¥¼ ì²˜ë¦¬í•˜ê¸° ìœ„í•œ ê³µì‹ ë¯¸ë“¤ì›¨ì–´ì…ë‹ˆë‹¤. ì´ ë¯¸ë“¤ì›¨ì–´ëŠ” APIì—ì„œ ë°œìƒí•˜ëŠ” ì˜ˆì™¸ë¥¼ ìë™ìœ¼ë¡œ ìºì¹˜í•˜ê³ , í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ì ì ˆí•œ JSON í˜•íƒœì˜ ì˜¤ë¥˜ ì‘ë‹µì„ ë°˜í™˜í•©ë‹ˆë‹¤.

```pascal
uses 
  Horse, 
  Horse.Jhonson, // It's necessary to use the unit
  Horse.HandleException, // It's necessary to use the unit
  System.JSON;

begin
  // It's necessary to add the middlewares in the Horse:
  THorse
    .Use(Jhonson) // It has to be before the exceptions middleware
    .Use(HandleException);

  THorse.Post('/ping',
    procedure(Req: THorseRequest; Res: THorseResponse; Next: TProc)
    begin
      // Manage your exceptions:
      raise EHorseException.New.Error('My Error!');
    end);

  THorse.Listen(9000);
end.
```

##### 3.2.7 logger

ê°œë°œëœ APIì˜ ë¡œê·¸ë¥¼ ë“±ë¡í•˜ê¸° ìœ„í•œ ê³µì‹ ë¯¸ë“¤ì›¨ì–´ì…ë‹ˆë‹¤. ì´ ë¯¸ë“¤ì›¨ì–´ëŠ” HTTP ìš”ì²­ê³¼ ì‘ë‹µì— ëŒ€í•œ ì ‘ê·¼ ë¡œê·¸ë¥¼ ìë™ìœ¼ë¡œ ê¸°ë¡í•˜ì—¬ APIì˜ ëª¨ë‹ˆí„°ë§ê³¼ ë””ë²„ê¹…ì„ ì§€ì›í•©ë‹ˆë‹¤.

```pascal
uses 
  Horse, 
  Horse.Jhonson, // It's necessary to use the unit
  Horse.HandleException, // It's necessary to use the unit

begin
  THorse.Use(
    procedure(Req: THorseRequest; Res: THorseResponse; Next: TProc)
    begin
      Writeln(Format('[%s] %s %s', [
        FormatDateTime('yyyy-mm-dd hh:nn:ss', Now),
        Req.Method,
        Req.PathInfo
      ]));
      Next();
    end);

  THorse.Listen(9000);
end.
```

##### 3.2.8 compression

APIì˜ ì½˜í…ì¸ ë¥¼ ì••ì¶•í•˜ê¸° ìœ„í•œ ê³µì‹ ë¯¸ë“¤ì›¨ì–´ì…ë‹ˆë‹¤. ì´ ë¯¸ë“¤ì›¨ì–´ëŠ” HTTP ì‘ë‹µì„ ìë™ìœ¼ë¡œ ì••ì¶•í•˜ì—¬ ë„¤íŠ¸ì›Œí¬ íŠ¸ë˜í”½ì„ ì¤„ì´ê³  ì „ì†¡ ì†ë„ë¥¼ í–¥ìƒì‹œí‚µë‹ˆë‹¤.

ì§€ì›í•˜ëŠ” ì••ì¶• ë°©ì‹
í˜„ì¬ ë¯¸ë“¤ì›¨ì–´ëŠ” DEFLATEì™€ GZIPì„ ì‚¬ìš©í•˜ì—¬ ë°ì´í„°ë¥¼ ì••ì¶•í•  ìˆ˜ ìˆë„ë¡ ì¤€ë¹„ë˜ì–´ ìˆìŠµë‹ˆë‹¤.

| ì••ì¶• íƒ€ì… | Delphi | Lazarus |
| --------- | ------ | ------- |
| DEFLATE   | âœ…     | âœ…     |
| GZIP      | âœ…     | âŒ      |

```pascal
uses
  System.SysUtils,
  System.JSON,

  Horse,
  Horse.Jhonson,
  Horse.Compression;

begin
  THorse
    .Use(Compression())
    .Use(Jhonson);

  // ì¼ì • í¬ê¸° ì´ìƒë§Œ ì••ì¶•í•˜ë„ë¡ ì„¤ì •í•  ìˆ˜ ìˆë‹¤
  // THorse.Use(Compression(1024));

  THorse.Get('/ping',
    procedure(Req: THorseRequest; Res: THorseResponse; Next: TProc)
    var
      I: Integer;
      LPong: TJSONArray;
    begin
      LPong := TJSONArray.Create;
      for I := 0 to 1000 do
        LPong.Add(TJSONObject.Create(TJSONPair.Create('ping', 'pong')));
      Res.Send(LPong);
    end);

  THorse.Listen(9000);
end.
```

### **4. ë°ì´í„°ë² ì´ìŠ¤ ì—°ë™ ì„œë²„**

#### 4.1 ë°ì´í„°ë² ì´ìŠ¤ ë° ìƒ˜í”Œ ë°ì´í„° ìƒì„±

```sql
DROP TABLE IF EXISTS users;
CREATE TABLE users (
  seq INTEGER AUTO_INCREMENT PRIMARY KEY,
  usr_id VARCHAR(12) NOT NULL,
  usr_nm VARCHAR(50) NOT NULL,
  usr_pw VARCHAR(64) NOT NULL,
  usr_lvl INTEGER
);
```

#### 4.2 FireDAC ì—°ê²° í’€ ë§Œë“¤ê¸°

- ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° í’€ì„ ì‚¬ìš©í•´ì•¼ í•˜ëŠ” ì´ìœ 
  - ì„±ëŠ¥ ì €í•˜
  - ë¦¬ì†ŒìŠ¤ ë‚­ë¹„
  - ì—°ê²° í•œê³„ ì´ˆê³¼ì‹œ ë°ì´í„°ë² ì´ìŠ¤ ì„±ëŠ¥ ì €í•˜ ë˜ëŠ” ë‹¤ìš´
    MySQL ê¸°ë³¸ max_connections = 151
    PostgreSQL ê¸°ë³¸ max_connections = 100
- FireDACì€ í’€ë§ì„ ê¸°ë³¸ìœ¼ë¡œ ì§€ì›í•œë‹¤

```pascal
unit uDBPool;

interface

{$REGION 'USES'}
uses
  System.SysUtils,
  System.Classes,
  System.Generics.Collections,
  System.NetEncoding,

  Data.DB,

  FireDAC.Comp.UI,
  FireDAC.UI.Intf,
  FireDAC.VCLUI.Wait,
  FireDAC.Stan.Def,
  FireDAC.Stan.Intf,
  FireDAC.Stan.Pool,
  FireDAC.Stan.Async,
  FireDAC.Stan.Param,
  FireDAC.DApt,
  FireDAC.Phys.MySQL,
  FireDAC.Comp.Client,
  FireDAC.Comp.Script;
{$ENDREGION}

type
  TDatabase = class sealed
  strict private
    const
      CONNECTION_NAME = '_pooled_connection_';

    class constructor Create;
    class destructor Destroy;
  public
    class function  GetConnection: TFDConnection; static;
  end;

implementation

{$REGION 'TDatabase'}

class constructor TDatabase.Create;
begin
  var LParams := TStringList.Create;
  try
    LParams.Add('Server=127.0.0.1');
    LParams.Add('Port=3306');
    LParams.Add('Database=pos_db');
    LParams.Add('User_Name=root');
    LParams.Add('Password=1');
    LParams.Add('Pooled=True');
    LParams.Add('CharacterSet=Utf8');

    FDManager.AddConnectionDef(CONNECTION_NAME, 'MySQL', LParams);
  finally
    LParams.Free;
  end;
end;

class destructor TDatabase.Destroy;
begin
  FDManager.CloseConnectionDef(CONNECTION_NAME);
end;

class function TDatabase.GetConnection: TFDConnection;
begin
  Result := TFDConnection.Create(nil);
  Result.ConnectionDefName := CONNECTION_NAME;
  Result.Connected := True;
end;

{$ENDREGION}

end.
```

#### 4.3 API ì„¤ê³„

| HTTP ë©”ì†Œë“œ | URL           | ë™ì‘                  |
| ----------- | ------------- | --------------------- |
| GET         | /api/user     | ì „ì²´ ì‚¬ìš©ì ëª©ë¡ ì¡°íšŒ |
| GET         | /api/user/:id | íŠ¹ì • ì‚¬ìš©ì ì¡°íšŒ      |
| POST        | /api/user     | ì‚¬ìš©ì ìƒì„±           |
| PUT         | /api/user/:id | ì‚¬ìš©ì ìˆ˜ì •           |
| DELETE      | /api/user/:id | íŠ¹ì • ì‚¬ìš©ì ì‚­ì œ      |

#### 4.4 êµ¬í˜„

```pascal
program DBServer;

{$APPTYPE CONSOLE}

uses
  System.SysUtils,
  System.Classes,
  System.JSON,

  Data.DB,
  uDBPool,

  Horse;

begin
  // ì „ì²´ ì¡°íšŒ
  THorse.Get('/user',
    procedure(Req: THorseRequest; Res: THorseResponse; Next: TProc)
    begin
      var LConnection := TDatabase.GetConnection;
      var LQuery := LConnection.GetQuery;
      try
        LQuery.SQL.Text := '''
        SELECT
          USR_ID
          , USR_NM
          , USR_LVL
        FROM
          USRS
        ''';
        LQuery.Open;

        Res.ContentType('application/json');
        Res.Send(LQuery.ToJSON);
      finally
        LQuery.Free;
        LConnection.Free;
      end;
    end);

  // ë‹¨ê±´ ì¡°íšŒ
  THorse.Get('/user/:id',
    procedure(Req: THorseRequest; Res: THorseResponse; Next: TProc)
    begin
      var LConnection := TDatabase.GetConnection;
      var LQuery := LConnection.GetQuery;
      try
        LQuery.SQL.Text := '''
        SELECT
          USR_ID
          , USR_NM
          , USR_LVL
        FROM
          USRS
        WHERE
          USR_ID = :USR_ID
        ''';
        LQuery.Params.ParamByName('USR_ID').AsString := Req.Params['id'];
        LQuery.Open;

        Res.ContentType('application/json');
        Res.Send(LQuery.ToJSON);
      finally
        LQuery.Free;
        LConnection.Free;
      end;
    end);

  // ì‚­ì œ
  THorse.Delete('/user/:id',
    procedure(Req: THorseRequest; Res: THorseResponse; Next: TProc)
    begin
      var LConnection := TDatabase.GetConnection;
      var LQuery := LConnection.GetQuery;
      try
        LQuery.SQL.Text := '''
        DELETE
        FROM
          USRS
        WHERE
          USR_ID = :USR_ID
        ''';
        LQuery.Params.ParamByName('USR_ID').AsString := Req.Params['id'];
        LQuery.ExecSQL;

        Res.ContentType('application/json');
        Res.Send('{"result": "OK"}');
      finally
        LQuery.Free;
        LConnection.Free;
      end;
    end);

  // ë“±ë¡
  THorse.Post('/user',
    procedure(Req: THorseRequest; Res: THorseResponse; Next: TProc)
    begin
      var LConnection := TDatabase.GetConnection;
      var LQuery := LConnection.GetQuery;
      try
        LQuery.SQL.Text := '''
        INSERT INTO USRS
        (
          USR_ID
          , USR_PW
          , USR_NM
          , USR_LVL
        )
        VALUES
        (
          :USR_ID
          , :USR_PW
          , :USR_NM
          , :USR_LVL
        )
        ''';

        var LJSON := TJSONObject.ParseJSONValue(Req.Body) as TJSONObject;
        LQuery.Params.ParamByName('USR_ID').AsString := LJSON.GetValue<string>('usr_id');
        LQuery.Params.ParamByName('USR_PW').AsString := '1234';
        LQuery.Params.ParamByName('USR_NM').AsString := LJSON.GetValue<string>('usr_nm');
        LQuery.Params.ParamByName('USR_LVL').AsInteger := LJSON.GetValue<Integer>('usr_lvl');
        LQuery.ExecSQL;
        LJSON.Free;
        Res.ContentType('application/json');
        Res.Send(LQuery.ToJSON);
      finally
        LQuery.Free;
        LConnection.Free;
      end;
    end);

  // ìˆ˜ì •
  THorse.Put('/user/:id',
    procedure(Req: THorseRequest; Res: THorseResponse; Next: TProc)
    begin
      var LConnection := TDatabase.GetConnection;
      var LQuery := LConnection.GetQuery;
      try
        LQuery.SQL.Text := '''
        UPDATE USRS
        SET
          USR_NM = :USR_NM
          , USR_LVL = :USR_LVL
        WHERE
          USR_ID = :USR_ID
        ''';

        var LJSON := TJSONObject.ParseJSONValue(Req.Body) as TJSONObject;
        LQuery.Params.ParamByName('USR_ID').AsString := Req.Params['id'];
        LQuery.Params.ParamByName('USR_NM').AsString := LJSON.GetValue<string>('usr_nm');
        LQuery.Params.ParamByName('USR_LVL').AsInteger := LJSON.GetValue<Integer>('usr_lvl');
        LQuery.ExecSQL;
        LJSON.Free;

        Res.ContentType('application/json');
        Res.Send(LQuery.ToJSON);
      finally
        LQuery.Free;
        LConnection.Free;
      end;
    end);

  // 9000ë²ˆ í¬íŠ¸ë¥¼ ë¦¬ìŠ¤ë‹í•œë‹¤
  THorse.Listen(9000);
end.
```

### **5. API ë¬¸ì„œí™”ì™€ í…ŒìŠ¤íŠ¸**

#### 5.1 Swaggerë¥¼ ì‚¬ìš©í•´ì„œ ë¬¸ì„œí™” í•˜ê¸°

SWAGGERì˜ íŠ¹ì§•

- API ë¬¸ì„œí™” ìë™í™”
  ì½”ë“œì—ì„œ ì£¼ì„ì´ë‚˜ ì–´ë…¸í…Œì´ì…˜ì„ í†µí•´ API ë¬¸ì„œë¥¼ ìë™ìœ¼ë¡œ ìƒì„±í•©ë‹ˆë‹¤. ìˆ˜ë™ìœ¼ë¡œ ë¬¸ì„œë¥¼ ì‘ì„±í•˜ê³  ì—…ë°ì´íŠ¸í•  í•„ìš”ê°€ ì—†ì–´ ê°œë°œ íš¨ìœ¨ì„±ì´ ë†’ì•„ì§‘ë‹ˆë‹¤.
- OpenAPI ì‚¬ì–‘ ì¤€ìˆ˜
  OpenAPI Specification(OAS)ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•˜ì—¬ í‘œì¤€í™”ëœ ë°©ì‹ìœ¼ë¡œ REST APIë¥¼ ì •ì˜í•˜ê³  ë¬¸ì„œí™”í•©ë‹ˆë‹¤.
- ì¸í„°ë™í‹°ë¸Œ ë¬¸ì„œ
  Swagger UIë¥¼ í†µí•´ ì›¹ ë¸Œë¼ìš°ì €ì—ì„œ ì§ì ‘ APIë¥¼ í…ŒìŠ¤íŠ¸í•  ìˆ˜ ìˆëŠ” ëŒ€í™”í˜• ë¬¸ì„œë¥¼ ì œê³µí•©ë‹ˆë‹¤. ì‹¤ì œ API í˜¸ì¶œì„ í•´ë³´ë©´ì„œ ì‘ë‹µì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
- ì½”ë“œ ìƒì„±
  API ì‚¬ì–‘ì„œë¥¼ ê¸°ë°˜ìœ¼ë¡œ í´ë¼ì´ì–¸íŠ¸ SDK, ì„œë²„ ìŠ¤í… ì½”ë“œ ë“±ì„ ë‹¤ì–‘í•œ í”„ë¡œê·¸ë˜ë° ì–¸ì–´ë¡œ ìë™ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
- API ì„¤ê³„ ìš°ì„  ê°œë°œ
  ì½”ë“œ ì‘ì„± ì „ì— APIë¥¼ ë¨¼ì € ì„¤ê³„í•˜ê³  ë¬¸ì„œí™”í•˜ì—¬ íŒ€ ê°„ í˜‘ì—…ê³¼ API ì¼ê´€ì„±ì„ ê°œì„ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
- ë‹¤ì–‘í•œ ë„êµ¬ ì§€ì›
  Swagger Editor, Swagger UI, Swagger Codegen ë“± ë‹¤ì–‘í•œ ë„êµ¬ë“¤ì´ API ê°œë°œ ìƒëª…ì£¼ê¸° ì „ë°˜ì„ ì§€ì›í•©ë‹ˆë‹¤.

ì´ëŸ¬í•œ íŠ¹ì§•ë“¤ë¡œ ì¸í•´ SwaggerëŠ” í˜„ì¬ ê°€ì¥ ë„ë¦¬ ì‚¬ìš©ë˜ëŠ” API ë¬¸ì„œí™” ë° ê°œë°œ ë„êµ¬ ì¤‘ í•˜ë‚˜ê°€ ë˜ì—ˆìŠµë‹ˆë‹¤.

```pascal
program Middlware05;

{$APPTYPE CONSOLE}

uses
  System.SysUtils,
  System.Classes,

  Horse,
  Horse.GBSwagger;

type
  TUser = class
  private
    FID: Double;
    FName: String;
    FLastName: string;
  public
    property ID: Double read FID write FID;
    property Name: String read FName write FName;
    property LastName: string read FLastName write FLastName;
  end;

  TAPIError = class
  private
    FError: string;
  public
    property Error: string read FError write FError;
  end;

var
  App: THorse;

begin
  App := THorse.Create;

  // Access http://localhost:9000/swagger/doc/html
  App.Use(HorseSwagger);

  APP.Get('/user',
    procedure(Req: THorseRequest; Res: THorseResponse; Next: TProc)
    begin
    end);

  APP.Post('user',
    procedure (Req: THorseRequest; Resp: THorseResponse; Next: TProc)
    begin
    end);

  APP.Delete('user',
    procedure (Req: THorseRequest; Resp: THorseResponse; Next: TProc)
    begin
    end);

  Swagger
    .Info
      .Title('Database CRUD Sample')
      .Description('API Horse')
      .Contact
        .Name('ì‹œê³¨í”„ë¡œê·¸ë˜ë¨¸')
        .Email('civilian7@email.com')
        .URL('https://cafe.naver.com/delmadang')
      .&End
    .&End
    .BasePath('v1')
    .Path('user')
      .Tag('User')
      .GET('List All', 'List All Users')
        .AddResponse(200, 'successful operation')
          .Schema(TUser)
          .IsArray(True)
        .&End
        .AddResponse(400).&End
        .AddResponse(500).&End
      .&End
      .POST('Add user', 'Add a new user')
        .AddParamBody('User data', 'User data')
          .Required(True)
          .Schema('string')
        .&End
        .AddResponse(201, 'Created')
          .Schema(TUser)
        .&End
        .AddResponse(400, 'BadRequest')
          .Schema(TAPIError)
        .&End
        .AddResponse(500).&End
      .&End
      .DELETE('Delete user', 'Delete user')
        .AddParamQuery('userid', 'User ID')
          .Required(True)
          .Schema('string')
        .&End
        .AddResponse(201, 'Deleted')
          .Schema(TUser)
        .&End
        .AddResponse(400, 'BadRequest')
          .Schema(TAPIError)
        .&End
        .AddResponse(500).&End
      .&End
    .&End
  .&End;

  // 9000ë²ˆ í¬íŠ¸ë¥¼ ë¦¬ìŠ¤ë‹í•œë‹¤
  App.Listen(9000);
end.
```
