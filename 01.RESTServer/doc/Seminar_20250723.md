## ë¸íŒŒì´ Horseë¥¼ í™œìš©í•œ REST ì„œë²„ êµ¬í˜„ ì„¸ë¯¸ë‚˜

### **0. ì„¸ë¯¸ë‚˜ ê°œìš”**

#### 0.1 ê°œìš”

**ì´ ì†Œìš”ì‹œê°„**: 2ì‹œê°„ (120ë¶„)  
**ëŒ€ìƒ**: ë¸íŒŒì´ ê°œë°œ ê²½í—˜ì´ ìˆëŠ” ê°œë°œì  
**ëª©í‘œ**: Horse í”„ë ˆì„ì›Œí¬ë¥¼ ì‚¬ìš©í•˜ì—¬ ì‹¤ë¬´ì—ì„œ í™œìš© ê°€ëŠ¥í•œ REST API ì„œë²„ êµ¬ì¶•

#### 0.2 í•„ìš”í•œ ì‚¬ì „ ì¤€ë¹„ì‚¬í•­

- ë°ì´í„°ë² ì´ìŠ¤: [MariaDB](https://mariadb.org/download/)
- ì¿¼ë¦¬ ë¸Œë¼ìš°ì €: [DBEaver](https://dbeaver.io/download/)

#### 0.3 ê°œë°œ ë„êµ¬

- Delphi XE8 ì´ìƒ

### **1. REST API ê°œìš”**

#### 1.1 REST APIë€?

**REST API**ëŠ” ì›¹ì—ì„œ ë°ì´í„°ë¥¼ ì£¼ê³ ë°›ê¸° ìœ„í•œ í‘œì¤€ ê·œì¹™ì…ë‹ˆë‹¤.
ë§ˆì¹˜ ë ˆìŠ¤í† ë‘ì˜ ë©”ë‰´íŒì²˜ëŸ¼, í´ë¼ì´ì–¸íŠ¸ê°€ ì„œë²„ì—ê²Œ "ì´ëŸ° ë°ì´í„°ë¥¼ ë‹¬ë¼" ë˜ëŠ” "ì´ëŸ° ì‘ì—…ì„ í•´ë‹¬ë¼"ê³  ìš”ì²­í•˜ëŠ” ë°©ì‹ì„ ì •ì˜í•˜ë©°, í†µì‹  í”„ë¡œí† ì½œì€ HTTP/HTTPSë¥¼ ë°ì´í„°ëŠ” JSONì„ ì‚¬ìš©í•©ë‹ˆë‹¤.

> **REST** = **RE**presentational **S**tate **T**ransfer(í‘œí˜„ ìƒíƒœ ì „ì´)

#### 1.2 REST APIì˜ í•µì‹¬ êµ¬ì¡°

HTTP ë©”ì†Œë“œ + URL = ì‘ì—… ì •ì˜

<table>
  <th width=400px>ìš”ì²­</th>
  <th width=200px>ì˜ë¯¸</th>
  <tr>
    <td><b>GET</b> /users</td>
    <td>ì‚¬ìš©ì ëª©ë¡ ì¡°íšŒ</td>
  </tr>
  <tr>
    <td>GET /users/123</td>
    <td>123ë²ˆ ì‚¬ìš©ì ì¡°íšŒ</td>
  </tr>
  <tr>
    <td>POST /users</td>
    <td>ìƒˆ ì‚¬ìš©ì ìƒì„±</td>
  </tr>
  <tr>
    <td>PUTT /user/123</td>
    <td>123ë²ˆ ì‚¬ìš©ì ìˆ˜ì •</td>
  </tr>
  <tr>
    <td>DELETE /user/123</td>
    <td>123ë²ˆ ì‚¬ìš©ì ì‚­ì œ</td>
  </tr>
</table>


#### 1.3 REST APIì˜ 5ê°€ì§€ í•µì‹¬ ì›ì¹™

##### 1.3.1 ë¦¬ì†ŒìŠ¤ ì¤‘ì‹¬ ì„¤ê³„

HTTP ë©”ì†Œë“œëŠ” ë™ì‚¬ë¡œ, URLì€ ëª…ì‚¬ë¡œ í‘œí˜„í•œë‹¤

<table>
  <th width=400px>ìš”ì²­</th>
  <th width=200px>ë¹„ê³ </th>
  <tr>
    <td>GET /books/123</td>
    <td>ì¢‹ì€ ì˜ˆ</td>
  </tr>
  <tr>
    <td>GET /getBook/123</td>
    <td>ë‚˜ìœ ì˜ˆ</td>
  </tr>
</table>

##### 1.3.2 ë¬´ìƒíƒœ(Stateless)

ì„œë²„ëŠ” ì´ì „ ìš”ì²­ì„ ê¸°ì–µí•˜ì§€ ì•ŠìŒ. ë§¤ ìš”ì²­ë§ˆë‹¤ í•„ìš”í•œ ëª¨ë“  ì •ë³´ í¬í•¨í•´ì•¼ í•œë‹¤

> ë§¤ë²ˆ ì¸ì¦ í† í° í¬í•¨
> GET /api/users
> Authorization: Bearer abc123token

##### 1.3.3 í‘œì¤€ HTTP ë©”ì†Œë“œ ì‚¬ìš©

<table>
  <th width=400px>ë©”ì†Œë“œ</th>
  <th width=200px>ì˜ë¯¸</th>
  <tr>
    <td>GET</td>
    <td>ì¡°íšŒ</td>
  </tr>
  <tr>
    <td>POST</td>
    <td>ìƒì„±</td>
  </tr>
  <tr>
    <td>PUT</td>
    <td>ìˆ˜ì •</td>
  </tr>
  <tr>
    <td>DELETE</td>
    <td>ì‚­ì œ</td>
  </tr>
</table>

##### 1.3.4 ê³„ì¸µí™”ëœ êµ¬ì¡°

í´ë¼ì´ì–¸íŠ¸ëŠ” ì„œë²„ì˜ ë‚´ë¶€ êµ¬ì¡°ë¥¼ ëª°ë¼ë„ ë¨

```mermaid
flowchart TD
    %% í´ë¼ì´ì–¸íŠ¸ ê³„ì¸µ
    A1[ğŸ–¥ï¸ ì›¹ ë¸Œë¼ìš°ì €] --> B[ğŸšª API Gateway]
    A2[ğŸ“± ëª¨ë°”ì¼ ì•±] --> B
    A3[ğŸ’» ë°ìŠ¤í¬í†± ì•±] --> B
    
    %% API Gateway
    B --> |ì¸ì¦/ê¶Œí•œ í™•ì¸<br/>ìš”ì²­ ê²€ì¦<br/>ë¡œê¹…| C[âš–ï¸ ë¡œë“œë°¸ëŸ°ì„œ ]
    
    %% ë¡œë“œë°¸ëŸ°ì„œì—ì„œ ì„œë²„ë“¤ë¡œ ë¶„ì‚°
    C --> |íŠ¸ë˜í”½ ë¶„ì‚°| D1[ğŸ–¥ï¸ ì„œë²„ 1]
    C --> |íŠ¸ë˜í”½ ë¶„ì‚°| D2[ğŸ–¥ï¸ ì„œë²„ 2]
    C --> |íŠ¸ë˜í”½ ë¶„ì‚°| D3[ğŸ–¥ï¸ ì„œë²„ 3]
    
    %% ì„œë²„ë“¤ì´ ë°ì´í„°ë² ì´ìŠ¤ì— ì ‘ê·¼
    D1 --> E[ğŸ—„ï¸ ë°ì´í„°ë² ì´ìŠ¤<br/>RDBMS or NoSQL ]
    D2 --> E
    D3 --> E
    
    %% ìŠ¤íƒ€ì¼ ì •ì˜
    classDef client fill:#e1f5fe,stroke:#0277bd,stroke-width:2px
    classDef gateway fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px
    classDef loadbalancer fill:#fff3e0,stroke:#f57c00,stroke-width:2px
    classDef server fill:#e8f5e8,stroke:#388e3c,stroke-width:2px
    classDef database fill:#ffebee,stroke:#d32f2f,stroke-width:2px
    
    class A1,A2,A3 client
    class B gateway
    class C loadbalancer
    class D1,D2,D3 server
    class E database
```

##### 1.3.5 ìºì‹œ ê°€ëŠ¥

GET ìš”ì²­ ê²°ê³¼ëŠ” ìºì‹œí•˜ì—¬ ì„±ëŠ¥ í–¥ìƒ

> Cache-Control: max-age=3600
> ETag: "abc123"

### **2. HORSE í”„ë ˆì„ì›Œí¬ ì†Œê°œ**

#### 2.1 Horse í”„ë ˆì„ì›Œí¬ íŠ¹ì§•

##### 2.1.1 ê²½ëŸ‰í™”ì™€ ê³ ì„±ëŠ¥

- ë„¤ì´í‹°ë¸Œ ì»´íŒŒì¼
- ë©”ëª¨ë¦¬ íš¨ìœ¨ (ë§¤ìš° ì ì€ ë©”ëª¨ë¦¬ë§Œ ì‚¬ìš©í•œë‹¤)
- ë¹ ë¥¸ ì‹¤í–‰ ì†ë„
- ê²½ëŸ‰í™”ëœ ì›¹ í”„ë ˆì„ì›Œí¬
- ê°„ë‹¨í•œ ë¼ìš°íŒ… ì‹œìŠ¤í…œ

##### 2.1.2 ê°„ë‹¨í•˜ê³  ì§ê´€ì ì¸ ë¬¸ë²•

- í•™ìŠµ ê³¡ì„ ì´ ë‚®ìŒ
- Nodeì˜ Expressì™€ ìœ ì‚¬
- ê°€ë…ì„±ì´ ì¢‹ìŒ.

##### 2.1.3 ë‹¤ì–‘í•˜ê³  ê°•ë ¥í•œ ë¯¸ë“¤ì›¨ì–´ ì‹œìŠ¤í…œ

- ëª¨ë“ˆí™”: ê¸°ëŠ¥ë³„ë¡œ ë¯¸ë“¤ì›¨ì–´ ë¶„ë¦¬
- ì¬ì‚¬ìš©ì„±: ë‹¤ë¥¸ í”„ë¡œì íŠ¸ì—ì„œë„ ë™ì¼í•œ ë¯¸ë“¤ì›¨ì–´ ì‚¬ìš©
- í™•ì¥ì„±: í•„ìš”í•œ ë¯¸ë“¤ì›¨ì–´ë§Œ ì¶”ê°€/ì œê±° ê°€ëŠ¥

##### 2.1.4 ë‹¤ì–‘í•œ OS ì§€ì›

- Windows
- Linux
- macOS

##### 2.1.5 ë¸íŒŒì´ ìƒíƒœê³„ì™€ì˜ í†µí•©

- ê¸°ì¡´ ë¸íŒŒì´ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤
- FireDAC, UniDAC ë“± ë‹¤ì–‘í•œ ë°ì´í„°ë² ì´ìŠ¤ ë“œë¼ì´ë²„ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤

##### 2.1.6 ê°„í¸í•œ ë°°í¬ì™€ ìš´ì˜

- ë‹¨ì¼ ì‹¤í–‰íŒŒì¼ë¡œ ë°°í¬ì™€ ìš´ì˜ì´ í¸ë¦¬ (ëŸ°íƒ€ì„ ë¶ˆí•„ìš”)
- ë„ì»¤ë¡œ ë°°í¬ ê°€ëŠ¥
- í´ë¼ìš°ë“œì— ë°°í¬ ê°€ëŠ¥

##### 2.1.7 ë‹¤ë¥¸ í”„ë ˆì„ì›Œí¬ë“¤

- MARS
  https://github.com/andrea-magni/MARS
- WiRL
  https://github.com/delphi-blocks/WiRL
  MARSì™€ WiRLì€ ê°™ì€ ë¿Œë¦¬ì—ì„œ ë‚˜ì˜¨ ê²ƒìœ¼ë¡œ ë³´ì´ëŠ”ë° MARSê°€ êµ¬í˜„ëœ ê²ƒì´ ì¡°ê¸ˆ ë” ë§ì§€ë§Œ, WiRLì´ ì½”ë“œëŠ” í›¨ì”¬ ì •ê°ˆí•˜ë‹¤.
- DataSnap ë˜ëŠ” WebBroker
  ë¸íŒŒì´ì—ì„œ ê¸°ë³¸ìœ¼ë¡œ ì œê³µí•œë‹¤. 12.2ì—ì„œëŠ” ì›¹ìŠ¤í…ì‹¤ì„ ì‚¬ìš©í•´ì„œ í…œí”Œë¦¿ì„ ì‰½ê²Œ ë§Œë“¤ ìˆ˜ ìˆë‹¤.
- DelphiMVCFramework
  https://github.com/danieleteti/delphimvcframework
  ê°€ì¥ ì—…ë°ì´íŠ¸ê°€ í™œë°œí•˜ë‹¤. ì†ŒìŠ¤ì½”ë“œ ì •ëˆì´ ì˜ ì•ˆëœì ì€ ì•„ì‰½ë‹¤.
- TMS WebCore
  https://www.tmssoftware.com/site/tmswebcore.asp
  ë¸íŒŒì´ Formì„ ì›¹ìœ¼ë¡œ ì „í™˜í•´ì£¼ëŠ” ë“±ì˜ ê¸°ëŠ¥ì´ ìˆë‹¤. ìœ ë£Œ
- Intraweb
  https://www.atozed.com/intraweb/
  ê°€ì¥ ì˜¤ë˜ëœ ì†”ë£¨ì…˜. ìœ ë£Œ.
- UniGUI
  https://www.unigui.com/ 
  ìœ ë£Œ
- D2Bridge
  https://www.d2bridge.com.br/#
  ë¸íŒŒì´ Formì„ ì›¹ìœ¼ë¡œ ì „í™˜í•´ì£¼ëŠ” ë“±ì˜ ê¸°ëŠ¥ì´ ìˆë‹¤. ì˜¤í”ˆì†ŒìŠ¤
â€‹
ë‹¤ì–‘í•œ í”„ë ˆì„ì›Œí¬ê°€ ì¡´ì¬í•˜ë‹ˆ í•œë²ˆì¯¤ ê²€í† í•´ë³´ëŠ” ê²ƒë„ ì¢‹ì„ ë“¯ í•˜ë‹¤.

#### 2.2 ì†ŒìŠ¤ì½”ë“œ ë‹¤ìš´ë¡œë“œ

ë¸ë§ˆë‹¹ ê³µì‹ ë¦¬í¬ì§€í† ë¦¬ì—ì„œ í´ë¡ í•œë‹¤
[ë¸ë§ˆë‹¹ ì„¸ë¯¸ë‚˜ ë¦¬í¬ì§€í† ë¦¬](https://github.com/DELMadang/01.RESTServer)

í´ë¡  í›„ í´ë”ì˜ êµ¬ì„±ì€ ë‹¤ìŒê³¼ ê°™ë‹¤.

```console
01.RESTServer/
  â”œâ”€â”€ bin                     // ì‹¤í–‰ íŒŒì¼ì´ ìƒì„±ë˜ëŠ” ê³³
  â”œâ”€â”€ database
  â”‚   â””â”€â”€ schema.sql          // MariaDBìš© ìŠ¤í‚¤ë§ˆ
  â”œâ”€â”€ docs
  â”‚   â””â”€â”€ RestAPI.md          // í˜„ì¬ ë³´ê³  ìˆëŠ” ë¬¸ì„œ
  â”œâ”€â”€ lib
  â”‚   â”œâ”€â”€ Horse               // Horse ì—”ì§„ ìœ ë‹›ë“¤
  â”‚   â””â”€â”€ MiddleWare          // ë¯¸ë“¤ì›¨ì–´ ìœ ë‹›ë“¤
  â””â”€â”€ src
      â”œâ”€â”€ 00.Raw              // Indyë¥¼ ì‚¬ìš©í•œ ì„œë²„
      â”œâ”€â”€ 01.Basic            // ê¸°ë³¸ ì„œë²„
      â”œâ”€â”€ 02.MiddleWare       // ë¯¸ë“¤ì›¨ì–´ ì ìš©í•œ ì„œë²„
      â”œâ”€â”€ 03.Database         // ë°ì´í„°ë² ì´ìŠ¤ ì—°ë™ ì„œë²„
      â”œâ”€â”€ 04.Client           // í´ë¼ì´ì–¸íŠ¸
      â””â”€â”€ 99.NodeJS           // NodeJS 
```

#### 2.3 Indyë¥¼ ì‚¬ìš©í•˜ì—¬ êµ¬í˜„í•˜ê¸°

í”„ë ˆì„ì›Œí¬ì˜ ë„ì›€ì—†ì´ ì„œë²„ë¥¼ êµ¬í˜„í•´ ë³´ë©´ì„œ, í”„ë ˆì„ì›Œí¬ì˜ í•„ìš”ì„±ì— ëŒ€í•´ ì•Œì•„ë³¸ë‹¤

```pascal
constructor TfrmMain.Create(AOwner: TComponent);
begin
  inherited;

  FServer := TIdHttpServer.Create(Self);
end;

destructor TfrmMain.Destroy;
begin
  FServer.Active := False;
  FServer.Free;

  inherited;
end;

procedure TfrmMain.btnExecuteClick(Sender: TObject);
begin
  var LURL := Format('http://localhost:%d/hello', [FServer.Bindings[0].Port]);
  ShellExecute(0, 'open', PChar(LURL), nil, nil, SW_SHOW);
end;

procedure TfrmMain.btnStartClick(Sender: TObject);
begin
  Start;
end;

procedure TfrmMain.btnStopClick(Sender: TObject);
begin
  Stop;
end;

procedure TfrmMain.Start(const APort: Integer);
begin
  FServer.Bindings.Clear;

  with FServer.Bindings.Add do
  begin
    IP := '0.0.0.0';
    Port := APort;
  end;

  FServer.OnCommandGet := TriggerCommandGet;
  FServer.Active := True;
end;

procedure TfrmMain.Stop;
begin
  FServer.Active := False;
end;

procedure TfrmMain.TriggerCommandGet(AContext: TIdContext;
  ARequestInfo: TIdHTTPRequestInfo; AResponseInfo: TIdHTTPResponseInfo);
begin
  if SameText(ARequestInfo.URI, '/hello') then
  begin
    AResponseInfo.ContentType := 'application/json';
    AResponseInfo.ContentText := '{"response": "Hello, world"}';
  end;
end;
```

#### 2.4 ê¸°ë³¸ ì„œë²„ êµ¬í˜„

ê°€ì¥ ê¸°ë³¸ì´ ë˜ëŠ” ì„œë²„ë¥¼ êµ¬í˜„í•´ ë³´ë©´ì„œ ë¼ìš°í„°ì˜ ì‚¬ìš©ë²•ì— ëŒ€í•´ ìµíŒë‹¤.

```pascal
program BasicServer;

uses 
  System.SysUtils,
  Horse;

begin
  // ë¼ìš°í„°ì— ë“±ë¡í•œë‹¤
  THorse.Get('/hello', 
    procedure(Req: THorseRequest; Res: THorseResponse; Next: TProc)
    begin
      Res.Send('Hello World!');
    end);
  
  // 9000ë²ˆ í¬íŠ¸ë¥¼ ë¦¬ìŠ¤ë‹í•œë‹¤
  THorse.Listen(9000);
end.
```

### **3. ë¯¸ë“¤ì›¨ì–´**

#### 3.1 ë¯¸ë“¤ì›¨ì–´ë€?

- ìš”ì²­-ì‘ë‹µ ì‚¬ì´í´ì—ì„œì˜ ì¤‘ê°„ ì²˜ë¦¬
- ê³µì‹ ë¯¸ë“¤ì›¨ì–´
  - **horse/json** SON ì²˜ë¦¬ë¥¼ ìœ„í•œ ë¯¸ë“¤ì›¨ì–´
  - **horse/basic-auth** ê¸°ë³¸ ì¸ì¦ì§€ì›
  - **horse/cors** Cross-Origun Resource Sharing ì§€ì›
  - **horse/stream** ë°”ì´ë„ˆë¦¬ ìŠ¤íŠ¸ë¦¼ ì „ì†¡ ì§€ì›
  - **horse/jwt** JWT ì¸ì¦ ì§€ì›
  - **horse/exception** ìµì…‰ì…˜ ì²˜ë¦¬ ì§€ì›
  - **horse/logger** ë¡œê¹… ì§€ì›
  - **horse/compression** ì‘ë‹µ ì••ì¶• ì§€ì›
- ë¹„ê³µì‹ ë¯¸ë“¤ì›¨ì–´
  - ì‚¬ìš©ìë“¤ì´ ê°œë°œí•œ ë‹¤ì–‘í•œ ë¯¸ë“¤ì›¨ì–´ê°€ ì¡´ì¬í•˜ë©°
  - í•„ìš”ì— ë”°ë¼ ë¯¸ë“¤ì›¨ì–´ë¥¼ ì§ì ‘ ë§Œë“¤ì–´ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤

#### 3.2 ë¯¸ë“¤ì›¨ì–´ ì‚¬ìš©í•´ë³´ê¸°

##### 3.2.1 JSON ë¯¸ë“¤ì›¨ì–´

JSON ë¯¸ë“¤ì›¨ì–´ëŠ” ì›¹ ì„œë²„ë‚˜ API ì„œë²„ì—ì„œ JSON ë°ì´í„°ë¥¼ ìë™ìœ¼ë¡œ íŒŒì‹±í•˜ê³  ì²˜ë¦¬í•˜ëŠ” ì¤‘ê°„ ê³„ì¸µ(middleware) ì†Œí”„íŠ¸ì›¨ì–´ì…ë‹ˆë‹¤.

**JSON ë¯¸ë“¤ì›¨ì–´ì˜ ì—­í• **

- ìš”ì²­ ì²˜ë¦¬
  HTTP ìš”ì²­ ë³¸ë¬¸ì˜ JSONì„ ìë™ íŒŒì‹±
  Content-Type ê²€ì¦ (application/json)
  íŒŒì‹± ì—ëŸ¬ ì²˜ë¦¬
- ì‘ë‹µ ì²˜ë¦¬
  ê°ì²´ë¥¼ JSONìœ¼ë¡œ ìë™ ì§ë ¬í™”
  ì ì ˆí•œ Content-Type í—¤ë” ì„¤ì •
  JSON í¬ë§·íŒ… (ë“¤ì—¬ì“°ê¸°, ì••ì¶• ë“±)

```pascal
program Middlware01;

{$APPTYPE CONSOLE}

uses
  System.SysUtils,
  System.JSON,
  Horse,
  Horse.Jhonson;

begin
  // ë¯¸ë“¤ì›¨ì–´ ë“±ë¡
  THorse.Use(Jhonson());

  // ë¼ìš°í„°ì— ë“±ë¡í•œë‹¤
  THorse.Get('/hello',
    procedure(Req: THorseRequest; Res: THorseResponse; Next: TProc)
    var
      LResult: TJSONObject;
    begin
      LResult := TJSONObject.Create;
      LResult.AddPair('response', 'Hello, World');
      Res.Send<TJSONObject>(LResult);
    end);

  // 9000ë²ˆ í¬íŠ¸ë¥¼ ë¦¬ìŠ¤ë‹í•œë‹¤
  THorse.Listen(9000);
end.
```

##### 3.2.2 basic-auth

Basic Authenticationì€ HTTP í”„ë¡œí† ì½œì—ì„œ ê°€ì¥ ê¸°ë³¸ì ì¸ ì¸ì¦ ë°©ì‹ì…ë‹ˆë‹¤.
Basic Authentication ë™ì‘ ì›ë¦¬

1. ì¸ì½”ë”© ë°©ì‹

- ì‚¬ìš©ìëª…ê³¼ íŒ¨ìŠ¤ì›Œë“œë¥¼ ì½œë¡ (:)ìœ¼ë¡œ ì—°ê²°
- Base64ë¡œ ì¸ì½”ë”©
- HTTP í—¤ë”ì— í¬í•¨í•˜ì—¬ ì „ì†¡

```text
username:password â†’ Base64 ì¸ì½”ë”© â†’ dXNlcm5hbWU6cGFzc3dvcmQ=
```

2. HTTP í—¤ë” í˜•ì‹

```text
Authorization: Basic dXNlcm5hbWU6cGFzc3dvcmQ=
```

3. ë³´ì•ˆ ê³ ë ¤ì‚¬í•­

**ì¥ì :**
- êµ¬í˜„ì´ ê°„ë‹¨í•¨
- ëª¨ë“  HTTP í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì§€ì›
- ì„œë²„ ì„¸ì…˜ ìƒíƒœ ë¶ˆí•„ìš”

**ë‹¨ì :**
- Base64ëŠ” ì•”í˜¸í™”ê°€ ì•„ë‹Œ ì¸ì½”ë”© (ì‰½ê²Œ ë””ì½”ë”© ê°€ëŠ¥)
- ë§¤ ìš”ì²­ë§ˆë‹¤ ì¸ì¦ ì •ë³´ ì „ì†¡
- ë¸Œë¼ìš°ì €ì— íŒ¨ìŠ¤ì›Œë“œ ì €ì¥ ìœ„í—˜

```pascal
program Middlware02;

{$APPTYPE CONSOLE}

uses
  System.SysUtils,
  System.JSON,

  Horse,
  Horse.Jhonson,
  Horse.BasicAuthentication;

begin
  // ë¯¸ë“¤ì›¨ì–´ ë“±ë¡
  THorse.Use(Jhonson());

  // BasicAuthë¥¼ ì²˜ë¦¬í•˜ê¸° ìœ„í•œ ë¯¸ë“¤ì›¨ì–´
  THorse.Use(HorseBasicAuthentication(
    function(const AUsername, APassword: string): Boolean
    begin
      Result := AUsername.Equals('user') and APassword.Equals('password');
    end));

  // ë¼ìš°í„°ì— ë“±ë¡í•œë‹¤
  THorse.Get('/hello',
    procedure(Req: THorseRequest; Res: THorseResponse; Next: TProc)
    var
      LResult: TJSONObject;
    begin
      LResult := TJSONObject.Create;
      LResult.AddPair('response', 'Hello, World');
      Res.Send<TJSONObject>(LResult);
    end);

  // 9000ë²ˆ í¬íŠ¸ë¥¼ ë¦¬ìŠ¤ë‹í•œë‹¤
  THorse.Listen(9000);
end.
```

##### 3.2.3 cors

CORS(Cross-Origin Resource Sharing)ëŠ” ì›¹ ë¸Œë¼ìš°ì €ì˜ Same-Origin Policy(ë™ì¼ ì¶œì²˜ ì •ì±…) ì œí•œì„ ìš°íšŒí•˜ê¸° ìœ„í•´ ì‚¬ìš©ë©ë‹ˆë‹¤.

**Same-Origin Policyë€?**
ì›¹ ë¸Œë¼ìš°ì €ëŠ” ë³´ì•ˆìƒ ì´ìœ ë¡œ ë‹¤ìŒ ì¡°ê±´ì´ ëª¨ë‘ ê°™ì€ ê²½ìš°ì—ë§Œ ë¦¬ì†ŒìŠ¤ ì ‘ê·¼ì„ í—ˆìš©í•©ë‹ˆë‹¤:

- í”„ë¡œí† ì½œ (http/https)
- ë„ë©”ì¸ (example.com)
- í¬íŠ¸ (80, 443, 8080 ë“±)

**CORS ë™ì‘ ê³¼ì •**

- Preflight Request: ë¸Œë¼ìš°ì €ê°€ OPTIONS ìš”ì²­ìœ¼ë¡œ ì„œë²„ì— í—ˆê°€ ìš”ì²­
- ì„œë²„ ì‘ë‹µ: í—ˆìš©ëœ origin, ë©”ì„œë“œ, í—¤ë” ì •ë³´ ë°˜í™˜
- ì‹¤ì œ ìš”ì²­: í—ˆê°€ë°›ì€ ê²½ìš°ì—ë§Œ ì‹¤ì œ API í˜¸ì¶œ ì‹¤í–‰

**ì£¼ì˜ì‚¬í•­**

- ë³´ì•ˆ: * (ëª¨ë“  ë„ë©”ì¸ í—ˆìš©)ì€ ìš´ì˜ í™˜ê²½ì—ì„œ ìœ„í—˜
- ì„±ëŠ¥: Preflight ìš”ì²­ìœ¼ë¡œ ì¸í•œ ì¶”ê°€ ë„¤íŠ¸ì›Œí¬ ë¹„ìš©
- ì„¤ì •: í•„ìš”í•œ originë§Œ ì •í™•íˆ í—ˆìš©í•´ì•¼ í•¨

CORSëŠ” ì›¹ ë¸Œë¼ìš°ì €ì—ì„œë§Œ ì ìš©ë˜ëŠ” ì •ì±…ì´ë¯€ë¡œ, ë°ìŠ¤í¬í†± ì• í”Œë¦¬ì¼€ì´ì…˜ì´ë‚˜ ì„œë²„ ê°„ í†µì‹ ì—ëŠ” ì˜í–¥ì„ ì£¼ì§€ ì•ŠìŠµë‹ˆë‹¤.

```pascal
program Middlware03;

{$APPTYPE CONSOLE}

uses
  System.SysUtils,
  System.JSON,

  Horse,
  Horse.Jhonson,
  Horse.BasicAuthentication,
  Horse.CORS;

begin
  // ë¯¸ë“¤ì›¨ì–´ ë“±ë¡
  HorseCORS
    .AllowedOrigin('*')
    .AllowedCredentials(true)
    .AllowedHeaders('*')
    .AllowedMethods('*')
    .ExposedHeaders('*');

  // It's necessary to add the middleware in the Horse:
  THorse.Use(CORS);

  THorse.Use(Jhonson());

  // BasicAuthë¥¼ ì²˜ë¦¬í•˜ê¸° ìœ„í•œ ë¯¸ë“¤ì›¨ì–´
  THorse.Use(HorseBasicAuthentication(
    function(const AUsername, APassword: string): Boolean
    begin
      Result := AUsername.Equals('user') and APassword.Equals('password');
    end));

  // ë¼ìš°í„°ì— ë“±ë¡í•œë‹¤
  THorse.Get('/hello',
    procedure(Req: THorseRequest; Res: THorseResponse; Next: TProc)
    var
      LResult: TJSONObject;
    begin
      LResult := TJSONObject.Create;
      LResult.AddPair('response', 'Hello, World');
      Res.Send<TJSONObject>(LResult);
    end);

  // 9000ë²ˆ í¬íŠ¸ë¥¼ ë¦¬ìŠ¤ë‹í•œë‹¤
  THorse.Listen(9000);
end.
```

##### 3.2.4 stream

```pascal
program Middlware01;

{$APPTYPE CONSOLE}

uses
  System.SysUtils,
  System.Classes,

  Horse,
  Horse.OctetStream;

begin
  THorse.Use(OctetStream);

  THorse.Get('/stream',
    procedure(Req: THorseRequest; Res: THorseResponse; Next: TProc)
    var
      LStream: TFileStream;
    begin
      LStream := TFileStream.Create(ExtractFilePath(ParamStr(0)) + 'horse.pdf', fmOpenRead);
      Res.Send<TStream>(LStream);
    end);

  // 9000ë²ˆ í¬íŠ¸ë¥¼ ë¦¬ìŠ¤ë‹í•œë‹¤
  THorse.Listen(9000);
end.
```

##### 3.2.5 jwt

```pascal
uses 
  Horse, 
  Horse.JWT;

begin
  THorse.Use(HorseJWT('MY-PASSWORD')); 

  THorse.Post('ping',
    procedure(Req: THorseRequest; Res: THorseResponse; Next: TProc)
    begin
      Res.Send('pong');
    end);

  THorse.Listen(9000);
end.
```

##### 3.2.6 exception

```pascal
uses 
  Horse, 
  Horse.Jhonson, // It's necessary to use the unit
  Horse.HandleException, // It's necessary to use the unit
  System.JSON;

begin
  // It's necessary to add the middlewares in the Horse:
  THorse
    .Use(Jhonson) // It has to be before the exceptions middleware
    .Use(HandleException);

  THorse.Post('/ping',
    procedure(Req: THorseRequest; Res: THorseResponse; Next: TProc)
    begin
      // Manage your exceptions:
      raise EHorseException.New.Error('My Error!');
    end);

  THorse.Listen(9000);
end.
```

##### 3.2.7 logger

```pascal
uses 
  Horse, 
  Horse.Jhonson, // It's necessary to use the unit
  Horse.HandleException, // It's necessary to use the unit

begin
  THorse.Use(
    procedure(Req: THorseRequest; Res: THorseResponse; Next: TProc)
    begin
      Writeln(Format('[%s] %s %s', [
        FormatDateTime('yyyy-mm-dd hh:nn:ss', Now),
        Req.Method,
        Req.PathInfo
      ]));
      Next();
    end);

  THorse.Listen(9000);
end.
```

##### 3.2.8 compression

```pascal
uses
  Horse,
  Horse.Jhonson,
  Horse.Compression, // It's necessary to use the unit
  System.JSON;

begin
  THorse
    .Use(Compression()) // Must come before Jhonson middleware
    .Use(Jhonson);

  // You can set compression threshold:
  // THorse.Use(Compression(1024));

  THorse.Get('/ping',
    procedure(Req: THorseRequest; Res: THorseResponse; Next: TProc)
    var
      I: Integer;
      LPong: TJSONArray;
    begin
      LPong := TJSONArray.Create;
      for I := 0 to 1000 do
        LPong.Add(TJSONObject.Create(TJSONPair.Create('ping', 'pong')));
      Res.Send(LPong);
    end);

  THorse.Listen(9000);
end.
```

### **4. ë°ì´í„°ë² ì´ìŠ¤ ì—°ë™ ì„œë²„**

#### 4.1 ë°ì´í„°ë² ì´ìŠ¤ ë° ìƒ˜í”Œ ë°ì´í„° ìƒì„±

```sql
DROP TABLE IF EXISTS users;
CREATE TABLE users (
  seq INTEGER AUTO_INCREMENT PRIMARY KEY,
  usr_id VARCHAR(12) NOT NULL,
  usr_name VARCHAR(50) NOT NULL,
  usr_pw VARCHAR(64) NOT NULL,
  email VARCHAR(100)
);
```

#### 4.2 FireDAC ì—°ê²° í’€ ë§Œë“¤ê¸°

- ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° í’€ì„ ì‚¬ìš©í•´ì•¼ í•˜ëŠ” ì´ìœ 
  - ì„±ëŠ¥ ì €í•˜
  - ë¦¬ì†ŒìŠ¤ ë‚­ë¹„
  - ì—°ê²° í•œê³„ ì´ˆê³¼ì‹œ ë°ì´í„°ë² ì´ìŠ¤ ì„±ëŠ¥ ì €í•˜ ë˜ëŠ” ë‹¤ìš´
    MySQL ê¸°ë³¸ max_connections = 151
    PostgreSQL ê¸°ë³¸ max_connections = 100
- FireDACì€ í’€ë§ì„ ê¸°ë³¸ìœ¼ë¡œ ì§€ì›í•œë‹¤

```pascal
unit uDBPool;

interface

{$REGION 'USES'}
uses
  System.SysUtils,
  System.Classes,
  System.Generics.Collections,
  System.NetEncoding,

  Data.DB,

  FireDAC.Comp.UI,
  FireDAC.UI.Intf,
  FireDAC.VCLUI.Wait,
  FireDAC.Stan.Def,
  FireDAC.Stan.Intf,
  FireDAC.Stan.Pool,
  FireDAC.Stan.Async,
  FireDAC.Stan.Param,
  FireDAC.DApt,
  FireDAC.Phys.MySQL,
  FireDAC.Comp.Client,
  FireDAC.Comp.Script;
{$ENDREGION}

type
  TDatabase = class sealed
  strict private
    const
      CONNECTION_NAME = '_pooled_connection_';

    class constructor Create;
    class destructor Destroy;
  public
    class function  GetConnection: TFDConnection; static;
  end;

implementation

{$REGION 'TDatabase'}

class constructor TDatabase.Create;
begin
  var LParams := TStringList.Create;
  try
    LParams.Add('Server=127.0.0.1');
    LParams.Add('Port=3306');
    LParams.Add('Database=pos_db');
    LParams.Add('User_Name=root');
    LParams.Add('Password=1');
    LParams.Add('Pooled=True');
    LParams.Add('CharacterSet=Utf8');

    FDManager.AddConnectionDef(CONNECTION_NAME, 'MySQL', LParams);
  finally
    LParams.Free;
  end;
end;

class destructor TDatabase.Destroy;
begin
  FDManager.CloseConnectionDef(CONNECTION_NAME);
end;

class function TDatabase.GetConnection: TFDConnection;
begin
  Result := TFDConnection.Create(nil);
  Result.ConnectionDefName := CONNECTION_NAME;
  Result.Connected := True;
end;

{$ENDREGION}

end.
```

#### 4.3 API ì„¤ê³„

|HTTP ë©”ì†Œë“œ|URL|ë™ì‘|
|--|--|--|
|GET|/api/users|ì „ì²´ ì‚¬ìš©ì ëª©ë¡ ì¡°íšŒ|
|GET|/api/users/:id|íŠ¹ì • ì‚¬ìš©ì ì¡°íšŒ|
|POST|/api/users|ì‚¬ìš©ì ìƒì„±|
|DELETE|/api/users/:id|íŠ¹ì • ì‚¬ìš©ì ì‚­ì œ|

#### 4.4 êµ¬í˜„

```pascal
```

### **5. API ë¬¸ì„œí™”ì™€ í…ŒìŠ¤íŠ¸**

#### 5.1 Swaggerë¥¼ ì‚¬ìš©í•´ì„œ ë¬¸ì„œí™” í•˜ê¸°

```pascal
uses
  Horse,
  Horse.GBSwagger;
  
type
  TUser = class
  private
    Fid: Double;
    Fname: String;
    FlastName: string;
  public
    property id: Double read Fid write Fid;
    property name: String read Fname write Fname;
    property lastName: string read FlastName write FlastName;
  end;

  TAPIError = class
  private
    Ferror: string;
  public
    property error: string read Ferror write Ferror;
  end;
  
var
  APP: THorse;
  
begin
  App := THorse.Create(9000);

  // Access http://localhost:9000/swagger/doc/html
  App.Use(HorseSwagger); 
  
  API.Get ('user', 
    procedure (Req: THorseRequest; Resp: THorseResponse; Next: TProc) 
    begin 
    end);
  
  API.Post('user', 
    procedure (Req: THorseRequest; Resp: THorseResponse; Next: TProc) 
    begin 
    end);
  
  Swagger
    .BasePath('v1')
    .Path('user')
      .Tag('User')
      .GET('List All', 'List All Users')
        .AddResponse(200, 'successful operation')
          .Schema(TUser)
          .IsArray(True)
        .&End
        .AddResponse(400, 'Bad Request')
          .Schema(TAPIError)
        .&End
        .AddResponse(500, 'Internal Server Error')
          .Schema(TAPIError)
        .&End
      .&End
      .POST('Add user', 'Add a new user')
        .AddParamBody('User data', 'User data')
          .Required(True)
          .Schema(TUser)
        .&End
        .AddResponse(201, 'Created')
          .Schema(TUser)
        .&End
        .AddResponse(400, 'Bad Request')
          .Schema(TAPIError)
        .&End
        .AddResponse(500, 'Internal Server Error')
          .Schema(TAPIError)
        .&End
      .&End
    .&End
  .&End;

  App.Start;
end.
```